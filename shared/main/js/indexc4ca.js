var aidnlib,three,index,__extends=this&&this.__extends||function(){var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();!function(t){var s=function(){function t(){}return t.get=function(t){return this._data[t]},t.add=function(t,e){this._data[t]=e},t._data={},t}();t.Assets=s;var o=function(){};t.Ref=o;var e=function(){function t(){this.__keyCount=0,this.__updates={},this.__resizes={}}return t.prototype.initialize=function(){o.stw=aidn.window.width(),o.sth=aidn.window.height(),aidn.util.needExpandArea(!0),aidn.window.addDummyDiv()},t.prototype._start=function(){var t=this;o.time=Date.now()/1e3,aidn.window.resize(function(){return t._resize()},!0),this._resize(),this._update()},t.prototype.addUpdate=function(t,e){t.__key||(t.__key="key_"+this.__keyCount,this.__keyCount++),this.__updates[t.__key]=e},t.prototype.removeUpdate=function(t){t.__key&&delete this.__updates[t.__key]},t.prototype.addResize=function(t,e){t.__key2||(t.__key2="key_"+this.__keyCount,this.__keyCount++),this.__resizes[t.__key2]=e},t.prototype.removeResize=function(t){t.__key2&&delete this.__resizes[t.__key2]},t.prototype._update=function(){var t=Date.now()/1e3;for(var e in o.delta=t-o.time,o.time=t,this.__updates)this.__updates[e]()},t.prototype._resize=function(){for(var t in o.stw=aidn.window.width(),o.sth=aidn.window.height(),this.__resizes)this.__resizes[t]()},t}();t.MainBase=e;var n=function(){function t(){this._ori=0,this._dx=0,this._dy=0,this._rx=0,this._ry=0,this.__updates={},this.__keyCount=0,this._timeoutId=null,this._isAndroid=!1,this._ax=-1e3,this._ay=-1e3}return t.prototype.start=function(){var e=this;aidn.util.checkMobile()?(window.addEventListener("deviceorientation",function(t){return e._deviceorientation(t)}),window.addEventListener("orientationchange",function(t){return e._orientationchange(t)},!1),this._orientationchange(),this._timeoutId=setTimeout(function(){return e._failedDeviceOrientation()},2e3),this._isAndroid=aidn.util.checkAndroid()):($("body").on("mousemove",function(t){return e._mouseMove(t)}),this._update())},t.prototype.addUpdate=function(t,e){t.__keyx||(t.__keyx="keyx_"+this.__keyCount,this.__keyCount++),this.__updates[t.__keyx]=e},t.prototype.removeUpdate=function(t){t.__keyx&&delete this.__updates[t.__keyx]},t.prototype._updateRate=function(t,e){for(var n in this.__updates)this.__updates[n](t,e)},t.prototype._mouseMove=function(t){var e=o.stw/2,n=o.sth/2,i=aidn.event.getPos(t);this._dx=(i.x-e)/e,this._dy=(i.y-n)/n},t.prototype._update=function(){var t=this;this._rx+=(this._dx-this._rx)/5,this._ry+=(this._dy-this._ry)/5,this._updateRate(this._rx,this._ry),window.requestAnimationFrame(function(){return t._update()})},t.prototype._deviceorientation=function(t){var e=t.gamma,n=t.beta;if(null!=this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=null),0!=this._ori){var i=n;n=e,e=i,90==this._ori&&(n=-n),-90==this._ori&&(e=-e)}var o=e/35;o=Math.max(o,-1),o=Math.min(o,1);var r=n/35;r=Math.max(r,-1),r=Math.min(r,1),this._updateRate(o,r)},t.prototype._devicemotion=function(t){var e=t.accelerationIncludingGravity||t.acceleration;this._ax<-100?(this._ax=e.x,this._ay=e.y):(this._ax+=(e.x-this._ax)/3,this._ay+=(e.y-this._ay)/3);var n=Math.floor(10*this._ax)/10,i=-Math.floor(10*this._ay)/10;if(this._isAndroid&&(n=-n,i=-i),0!=this._ori){var o=i;i=n,n=o,90==this._ori&&(i=-i),-90==this._ori&&(n=-n)}var r=n/5;r=Math.max(r,-1),r=Math.min(r,1);var s=i/5;s=Math.max(s,-1),s=Math.min(s,1),this._updateRate(r,s)},t.prototype._orientationchange=function(t){void 0===t&&(t=null),this._ori=parseInt(window.orientation.toString())||0,-1==this._ori&&(this._ori=0)},t.prototype._failedDeviceOrientation=function(){var e=this;window.addEventListener("devicemotion",function(t){return e._devicemotion(t)})},t}();t.DeviceManager=n;var i=function(){function t(){this.listeners={}}return t.prototype.dispatchEvent=function(t){var e,n;if(t instanceof a?(n=t.type,e=t):e=new a(n=t),null!=this.listeners[n])for(var i=(e.currentTarget=this).listeners[n].length,o=0;o<i&&this.listeners[n];o++){var r=this.listeners[n][o];try{r.handler(e)}catch(t){window.console&&console.error(t.stack)}}},t.prototype.addEventListener=function(t,e,n){void 0===n&&(n=0),null==this.listeners[t]&&(this.listeners[t]=[]),this.listeners[t].push(new r(t,e,n)),this.listeners[t].sort(function(t,e){return e.priolity-t.priolity})},t.prototype.removeEventListener=function(t,e){if(this.hasEventListener(t,e))for(var n=0;n<this.listeners[t].length;n++){var i=this.listeners[t][n];if(i.equalCurrentListener(t,e))return i.handler=null,void this.listeners[t].splice(n,1)}},t.prototype.clearEventListener=function(){this.listeners={}},t.prototype.containEventListener=function(t){return null!=this.listeners[t]&&0<this.listeners[t].length},t.prototype.hasEventListener=function(t,e){if(null==this.listeners[t])return!1;for(var n=0;n<this.listeners[t].length;n++){if(this.listeners[t][n].equalCurrentListener(t,e))return!0}return!1},t}();t.EventDispatcher=i;var r=function(){function t(t,e,n){void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=0),this.type=t,this.handler=e,this.priolity=n}return t.prototype.equalCurrentListener=function(t,e){return this.type==t&&this.handler==e},t}(),a=function(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this.type=t,this.data=e};t.Event=a;var u=function(e){function t(){var t=e.call(this)||this;return t._loaded=!1,t}return __extends(t,e),t.prototype.execute=function(){},t.prototype.cancel=function(){},t.prototype._dispatchComplete=function(){this._loaded=!0,this.dispatchEvent(new c(c.COMPLETE))},t.prototype._dispatchFailed=function(){this.dispatchEvent(new c(c.FAILED))},t.prototype._dispatchProgress=function(t){var e=new c(c.PROGRESS);e.progress=t,this.dispatchEvent(e)},t}(i);t.CommandBase=u;var c=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t.COMPLETE="complete",t.FAILED="failed",t.PROGRESS="progress",t}(a);t.CommandEvent=c;var h=function(n){function t(t){void 0===t&&(t=1);var e=n.call(this)||this;return e._rates=[],e._sum=0,e._commands=[],e._now=0,e._total=0,e._compnum=0,e._compflags=[],e._connectionNum=t,e}return __extends(t,n),t.prototype.execute=function(){if(this._loaded=!1,this._now=this._compnum=this._compRate=0,this._compflags=[],this._progRates=[],this._total<=this._compnum)return this._dispatchProgress(1),void this._dispatchComplete();for(var t=Math.min(this._total,this._connectionNum),e=0;e<t;e++)this._execute()},t.prototype.cancel=function(){if(!(this._total<=this._compnum))for(var t=0;t<this._total;t++)try{var e=this._commands[t];this._removeEvents(e),e.cancel()}catch(t){}},t.prototype.add=function(t,e){void 0===e&&(e=1),this._commands[this._total]=t,this._rates[this._total]=e,this._sum+=e,this._total++},t.prototype._execute=function(){var e=this;if(this._now<this._total){this._rates[this._now]=this._rates[this._now]/this._sum,this._progRates[this._now]=0;var t=this._commands[this._now];t.__id=this._now,t.addEventListener(c.COMPLETE,function(t){return e._complete(t)}),t.addEventListener(c.PROGRESS,function(t){return e._progress(t)}),t.addEventListener(c.FAILED,function(t){return e._failed(t)}),t.execute(),this._now++}else this._total<=this._compnum&&(this._dispatchProgress(1),this._dispatchComplete())},t.prototype._removeEvents=function(t){t.clearEventListener()},t.prototype._completeCommand=function(t,e){},t.prototype._complete=function(t){var e=t.currentTarget.__id,n=this._commands[e];this._removeEvents(n),this._compRate+=this._rates[e],this._compflags[e]=!0,this.__progress(),this._completeCommand(n,e),this._compnum++,this._execute()},t.prototype._progress=function(t){var e=t.currentTarget.__id;this._progRates[e]=t.progress*this._rates[e],this.__progress()},t.prototype.__progress=function(){for(var t=0,e=0;e<this._now;e++)this._compflags[e]||(t+=this._progRates[e]);this._dispatchProgress(this._compRate+t)},t.prototype._failed=function(t){var e=t.currentTarget.__id,n=this._commands[e];this._removeEvents(n),this._dispatchFailed()},Object.defineProperty(t.prototype,"loaded",{get:function(){return this._loaded},enumerable:!0,configurable:!0}),t}(u);t.SequentialCommand=h;var _=function(r){function t(t,e,n,i){void 0===e&&(e=null),void 0===n&&(n=!1),void 0===i&&(i=-1);var o=r.call(this)||this;return o._id=e,o._url=t,o._isplay=n,o._trimvol=i,o}return __extends(t,r),t.prototype.execute=function(){var e=this,t=function(){e._complete()},n=function(t){e._progress(t)};this._audio=new aidn.AutoAudio(null),this._isplay?(this._audio.load([this._url],null,this._trimvol,n),this._audio.play(0,!1,t,0,0)):this._audio.load([this._url],t,this._trimvol,n)},t.prototype._progress=function(t){this._dispatchProgress(t)},t.prototype._complete=function(){this._isplay&&this._audio.stop();var t=this._id;t||(t=this._url),s.add(t,this._audio),this._dispatchComplete()},t}(u);t.AudioLoadCommand=_;var p=function(o){function t(t,e,n){void 0===e&&(e=null),void 0===n&&(n=-1);var i=o.call(this)||this;return i._url=t,i._type=n,(i._name=e)||(i._name=t),i}return __extends(t,o),t.prototype.execute=function(){var t,e=this,n=new Image,i=this._name;t=this._type==f.PIXI?function(){var t=new PIXI.Texture(new PIXI.BaseTexture(n));PIXI.Texture.addTextureToCache(t,i),s.add(i,t),setTimeout(function(){e._complete()},10)}:this._type==f.THREE?function(){var t=new THREE.Texture(n);t.needsUpdate=!0,s.add(i,t),setTimeout(function(){e._complete()},10)}:function(){s.add(i,n),setTimeout(function(){e._complete()},10)},n.onload=t,n.src=this._url},t.prototype._complete=function(){this._dispatchComplete()},t}(u);t.ImageLoadCommand=p;var d=function(s){function t(t,e,n){void 0===e&&(e=1),void 0===n&&(n=0);for(var i=s.call(this,e)||this,o=t.length,r=0;r<o;r++)i.add(new l(t[r],n));return i}return __extends(t,s),t}(h);t.ScriptsLoaderCommand=d;var l=function(i){function t(t,e){void 0===e&&(e=0);var n=i.call(this)||this;return n._url=t,n._ver=e,n}return __extends(t,i),t.prototype.execute=function(){var t=this;$.ajax({url:this._url+"?"+this._ver,cache:!0,dataType:"script"}).then(function(){return t._complete()},function(){return t._failed()})},t.prototype._complete=function(){this._dispatchComplete()},t.prototype._failed=function(){this._dispatchFailed()},t}(u),f=function(){function t(){}return t.PIXI=0,t.THREE=1,t.IMG=2,t}();t.JsonBase64Type=f;var m=function(o){function t(t,e,n){void 0===e&&(e=0),void 0===n&&(n=.3);var i=o.call(this)||this;return i._keys=[],i._context=null,i._url=t,i._type=e,i._jsonRate=n,i}return __extends(t,o),t.prototype.execute=function(){var e=this,t={method:"GET",url:this._url,dataType:"json",success:function(t){e._complete(t)},xhr:function(){var t=$.ajaxSettings.xhr();return t.onprogress=function(t){e._dispatchProgress(e._jsonRate*(t.loaded/t.total))},t}};$.ajax(t)},t.prototype._setupAudio=function(t){this._context=t},t.prototype._complete=function(t){this._data=t;var e=0;for(var n in t)this._keys[e++]=n;this._now=-1,this._len=e,this._next()},t.prototype._next=function(){if(this._now++,this._now<this._len){this._dispatchProgress(this._jsonRate+(1-this._jsonRate)*(this._now/this._len));var e=this,n=this._keys[this._now],t=this._data[n];if(0<n.lastIndexOf(".mp3")||0<n.lastIndexOf(".ogg"))if(aidn.util.webaudio){this._context&&(aidn.___waContext=this._context);var i=new aidn.WebAudio;s.add(n,i),i.load(t,function(){e._next()})}else setTimeout(function(){e._next()},10);else{var o,r=new Image;o=this._type==f.PIXI?function(){var t=new PIXI.Texture(new PIXI.BaseTexture(r));PIXI.Texture.addToCache?PIXI.Texture.addToCache(t,n):PIXI.Texture.addTextureToCache(t,n),s.add(n,t),setTimeout(function(){e._next()},10)}:this._type==f.THREE?function(){var t=new THREE.Texture(r);t.needsUpdate=!0,s.add(n,t),setTimeout(function(){e._next()},10)}:function(){s.add(n,r),setTimeout(function(){e._next()},10)},r.onload=o,r.src=t}}else this._dispatchComplete()},t}(u);t.JsonBase64LoadCommand=m;var y=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.set=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e,this},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.distance=function(t){var e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)},t}();t.Point=y;var v=function(){function t(){}return t.random=function(t){void 0===t&&(t=null);var e=this.seed;return null!=t&&(e=t),e^=e<<13,e^=e>>17,e^=e<<15,(this.seed=e)/4294967296+.5},t.randInt=function(t,e,n){return void 0===n&&(n=null),Math.floor(this.rand(t,e+1,n))},t.rand=function(t,e,n){return void 0===n&&(n=null),this.random(n)*(e-t)+t},t.arrayShuffle=function(t){for(var e=t.length,n=0;n<e;n++){var i=this.randInt(0,e-1),o=t[n];t[n]=t[i],t[i]=o}},t.seed=0,t}();t.Util=v}(aidnlib||(aidnlib={})),function(t){var e=aidnlib.CommandBase,a=aidnlib.Assets,r=aidnlib.Ref,n=function(o){function t(t,e,n){var i=o.call(this)||this;return i._keys=[],i._n=0,i._vs=[],i._url=t,i._loader=e,i._mesh=n,i}return __extends(t,o),t.prototype.execute=function(){var n=this;JSZipUtils.getBinaryContent(this._url,function(t,e){n._zipComplete(t,e)})},t.prototype._zipComplete=function(t,e){var n=this;JSZip.loadAsync(e).then(function(t){n._binayComplete(t)})},t.prototype._binayComplete=function(t){this._zip=t;var e=0;for(var n in t.files)this._keys[e++]=n;this._now=-1,this._len=e,this._next()},t.prototype._next=function(){if(this._now++,this._now<this._len){this._dispatchProgress(this._now/this._len);var e=this,n=this._keys[this._now];this._zip.file(n).async("arraybuffer").then(function(t){e._arrayComplete(t,n)})}else this._dispatchComplete()},t.prototype._arrayComplete=function(t,e){var n=this;if(0<e.lastIndexOf(".vmd")){var i=this._loader,o=i.parser.parseVmd(t,!0);this._vs.push(o);var r=this._mesh,s=i.animationBuilder.build(o,r);a.add("Motion"+this._n,s),a.add(e,s),this._n++}setTimeout(function(){return n._next()},10)},t}(e);t.ZipLoadCommand=n;var i=function(r){function t(t,e,n,i){void 0===e&&(e="motion"),void 0===n&&(n=null),void 0===i&&(i=null);var o=r.call(this)||this;return o._url=t,o._loader=n,o._mesh=i,o._key=e,o}return __extends(t,r),t.prototype.execute=function(){var e=this;this._loader||(this._loader=a.get("loader")),this._mesh||(this._mesh=a.get("mesh"));var t=new XMLHttpRequest;(this._xhr=t).open("GET",this._url,!0),t.responseType="arraybuffer",t.onload=function(t){return e._loadComplete(t)},t.send()},t.prototype._loadComplete=function(t){var e=this._xhr.response,n=this._loader,i=n.parser.parseVmd(e,!0),o=this._mesh,r=n.animationBuilder.build(i,o);a.add(this._key,r),this._dispatchComplete()},t}(e);t.ThreeVmdLoadCommand=i;var o=function(i){function t(t,e){void 0===e&&(e="mesh");var n=i.call(this)||this;return n._pmdUrl=t,n._key=e,n}return __extends(t,i),t.prototype.execute=function(){var e=this,t=new THREE.MMDLoader;a.add("loader",t),a.add(this._pmdUrl+"_loader",t),t.load(this._pmdUrl,function(t){e._complete(t)},function(t){e._progress(t)})},t.prototype._progress=function(t){if(t.lengthComputable){var e=t.loaded/t.total;this._dispatchProgress(e)}},t.prototype._complete=function(t){var e=t;a.add(this._key,e),a.add(this._pmdUrl,e),this._dispatchComplete()},t}(e);t.ThreePmdLoadCommand=o;var s=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=null),t||(t=new THREE.Object3D),this._target=t,e?(this._parent=e,this._parent.add(this._target)):this._parent=t.parent}return t.prototype.setPosVec=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t.prototype.setPos=function(t,e,n){return this.x=t,this.y=e,this.z=n,this},t.prototype.setRot=function(t,e,n){return this.rotationX=t,this.rotationY=e,this.rotationZ=n,this},t.prototype.getPos=function(){return this._target.position.clone()},t.prototype.getRot=function(){return this._target.rotation},t.prototype.get2D=function(t,e){void 0===e&&(e=null);var n=.5*r.stw,i=.5*r.sth,o=this._target.position.clone();return e&&o.add(e),o.project(t),o.x=Math.round((o.x+1)*n),o.y=Math.round((1-o.y)*i),new THREE.Vector2(o.x,o.y)},Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"target",{get:function(){return this._target},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._target.position.x},set:function(t){this._target.position.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._target.position.y},set:function(t){this._target.position.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this._target.position.z},set:function(t){this._target.position.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotationX",{get:function(){return this._target.rotation.x},set:function(t){this._target.rotation.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotationY",{get:function(){return this._target.rotation.y},set:function(t){this._target.rotation.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotationZ",{get:function(){return this._target.rotation.z},set:function(t){this._target.rotation.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scale",{get:function(){return this._target.scale.x},set:function(t){t=this.__checkSc(t),this._target.scale.set(t,t,t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleX",{get:function(){return this._target.scale.x},set:function(t){t=this.__checkSc(t),this._target.scale.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleY",{get:function(){return this._target.scale.y},set:function(t){t=this.__checkSc(t),this._target.scale.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scaleZ",{get:function(){return this._target.scale.z},set:function(t){t=this.__checkSc(t),this._target.scale.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return this._target.visible},set:function(t){this._target.visible=t},enumerable:!0,configurable:!0}),t.prototype.__checkSc=function(t){return 0==t&&(t=.001),t},Object.defineProperty(t.prototype,"renderOrder",{get:function(){return this._target.renderOrder},set:function(t){this._target.renderOrder=t},enumerable:!0,configurable:!0}),t}();t.ThreeBase=s;var h=function(){function t(t){this._bone=t,this._defRot=t.rotation.clone(),this._defPos=t.position.clone()}return Object.defineProperty(t.prototype,"bone",{get:function(){return this._bone},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"defRot",{get:function(){return this._defRot},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"defPos",{get:function(){return this._defPos},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._bone.position.x},set:function(t){this._bone.position.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._bone.position.y},set:function(t){this._bone.position.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this._bone.position.z},set:function(t){this._bone.position.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotationX",{get:function(){return this._bone.rotation.x},set:function(t){this._bone.rotation.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotationY",{get:function(){return this._bone.rotation.y},set:function(t){this._bone.rotation.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotationZ",{get:function(){return this._bone.rotation.z},set:function(t){this._bone.rotation.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scale",{get:function(){return this._bone.scale.x},set:function(t){this._bone.scale.set(t,t,t)},enumerable:!0,configurable:!0}),t.prototype.add=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];(t=this._bone).add.apply(t,e)},t}(),u=function(c){function t(t,e,n){void 0===n&&(n=!1);var i=c.call(this,t,e)||this;i._mesh=t,i._bones=[];for(var o=t.skeleton.bones.length,r=0;r<o;r++)i._bones[r]=new h(t.skeleton.bones[r]);var s=t.material;for(r=0;r<s.length;r++)if(n){var a=s[r],u=new THREE.MeshBasicMaterial({map:a.map,skinning:!0});u.userData.outlineParameters=[],t.material[r]=u,t.material[r].needsUpdate=!0}return i}return __extends(t,c),Object.defineProperty(t.prototype,"mesh",{get:function(){return this._mesh},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bones",{get:function(){return this._bones},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"acs",{get:function(){return this._acs},enumerable:!0,configurable:!0}),t.prototype.logInfo=function(){var t=this._mesh;console.log("mesh.morphTargetDictionary:"),console.log(t.morphTargetDictionary),console.log("mesh.skeleton.bones:"),console.log(t.skeleton.bones)},t.prototype.initAnimation=function(t,e){void 0===e&&(e=-1);var n=new THREE.MMDAnimationHelper({sync:!1});n.enabled.physics=!1,this._helper=n,this._helper.add(this._mesh,{animation:t,physics:!1});var i=this._helper.objects.get(this._helper.meshes[0]).mixer._actions;return this._acs=i,this.playAnimationId(e),i},t.prototype.playAnimationId=function(t){void 0===t&&(t=-1);for(var e=this._acs,n=0;n<e.length;n++)e[n].weight=n==t?1:0},t.prototype.update=function(){this._helper&&this._helper.update(r.delta)},t}(s);t.MMDManager=u;var c=function(i){function t(t,e){void 0===e&&(e=null);var n=i.call(this,t,e)||this;if(t.geometry)try{n._mesh=t}catch(t){}return t.geometry&&(n._geometry=t.geometry),t.material&&(n._material=t.material,n._map=n._material.map,n._color=n._material.color),n}return __extends(t,i),t.prototype.centerTrans=function(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this._geometry&&this._geometry.applyMatrix((new THREE.Matrix4).makeTranslation(t,e,n))},t.prototype.updateTexture=function(t,e){void 0===e&&(e=!1),this._material.map=t,this._material.needsUpdate=!0,this._map=this._material.map,this._material.blending=e?THREE.AdditiveBlending:THREE.NormalBlending},Object.defineProperty(t.prototype,"alpha",{get:function(){return this._material.opacity},set:function(t){this._material.opacity=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mesh",{get:function(){return this._mesh},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"geometry",{get:function(){return this._geometry},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"material",{get:function(){return this._material},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"texOffsetX",{get:function(){return this._map.offset.x},set:function(t){this._map.offset.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"texOffsetY",{get:function(){return this._map.offset.y},set:function(t){this._map.offset.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"texRepeatX",{get:function(){return this._map.repeat.x},set:function(t){this._map.repeat.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"texRepeatY",{get:function(){return this._map.repeat.y},set:function(t){this._map.repeat.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color.getHex()},set:function(t){this._color.setHex(t)},enumerable:!0,configurable:!0}),t}(s),_=function(o){function t(t,e){var n=this,i=new THREE.Sprite(e);return(n=o.call(this,i,t)||this)._sprite=i,n}return __extends(t,o),Object.defineProperty(t.prototype,"sprite",{get:function(){return this._sprite},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"material",{get:function(){return this._sprite.material},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotation",{get:function(){return this._sprite.material.rotation},set:function(t){this._sprite.material.rotation=t},enumerable:!0,configurable:!0}),t}(t.PrimBase=c);t.PrimSprite=_;var p=function(u){function t(t,e,n,i){void 0===e&&(e=null),void 0===n&&(n=-1),void 0===i&&(i=1);var o,r=this,s=new THREE.Geometry;if(s.vertices=t,0<=n){var a=new THREE.LineBasicMaterial({color:n,linewidth:i,linecap:"square",linejoin:"miter"});o=new THREE.Line(s,a)}else(o=new THREE.Line(s)).visible=!1;return(r=u.call(this,o,e)||this)._line=o,r}return __extends(t,u),Object.defineProperty(t.prototype,"line",{get:function(){return this._line},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"material",{get:function(){return this._line.material},enumerable:!0,configurable:!0}),t}(c);t.PrimLine=p;var d=function(c){function t(t,e,n,i,o,r){void 0===n&&(n=1),void 0===i&&(i=1),void 0===o&&(o=1),void 0===r&&(r=1);var s=this,a=new THREE.PlaneGeometry(n,i,o,r),u=new THREE.Mesh(a,e);return(s=c.call(this,u,t)||this)._mesh=u,s}return __extends(t,c),t}(c);t.PrimPlane=d;var l=function(_){function t(t,e,n,i,o,r,s,a){void 0===r&&(r=1),void 0===s&&(s=1),void 0===a&&(a=1);var u=this,c=new THREE.BoxGeometry(n,i,o,r,s,a),h=new THREE.Mesh(c,e);return(u=_.call(this,h,t)||this)._mesh=h,u}return __extends(t,_),t}(c);t.PrimCube=l;var f=function(u){function t(t,e,n,i,o){void 0===i&&(i=8),void 0===o&&(o=6);var r=this,s=new THREE.SphereGeometry(n,i,o),a=new THREE.Mesh(s,e);return(r=u.call(this,a,t)||this)._mesh=a,r}return __extends(t,u),t}(c);t.PrimSphere=f;var m=function(_){function t(t,e,n,i,o,r,s,a){void 0===r&&(r=8),void 0===s&&(s=1),void 0===a&&(a=!1);var u=this,c=new THREE.CylinderGeometry(n,i,o,r,s,a),h=new THREE.Mesh(c,e);return(u=_.call(this,h,t)||this)._mesh=h,u}return __extends(t,_),t}(c);t.PrimCylinder=m;var y=function(c){function t(t,e,n,i,o,r){void 0===o&&(o=8),void 0===r&&(r=1);var s=this,a=new THREE.RingGeometry(n,i,o,r),u=new THREE.Mesh(a,e);return(s=c.call(this,u,t)||this)._mesh=u,s}return __extends(t,c),t}(c);t.PrimRing=y;var v=function(c){function t(t,e,n,i,o,r){void 0===i&&(i=2),void 0===o&&(o=8),void 0===r&&(r=8);var s=this,a=new THREE.TorusGeometry(n,i,r,o),u=new THREE.Mesh(a,e);return(s=c.call(this,u,t)||this)._mesh=u,s}return __extends(t,c),t}(c);t.PrimTorus=v}(three||(three={})),function(t){var h=aidn.math,n=aidnlib.Ref,e=aidnlib.MainBase,_=aidnlib.Assets,i=aidnlib.DeviceManager,o=aidnlib.JsonBase64LoadCommand,r=aidnlib.JsonBase64Type,s=aidnlib.SequentialCommand,a=aidnlib.CommandEvent,u=three.ThreeBase;t.check=function(){!function t(){"undefined"==typeof aidn||"undefined"==typeof jQuery?setTimeout(function(){return t()},10):$(function(){p.main||new d})}(),function t(){"undefined"==typeof aidn||"undefined"==typeof jQuery||"undefined"==typeof THREE?setTimeout(function(){return t()},10):$(function(){p.main?p.main.initialize():(new d).initialize()})}()};var p=function(){function t(){}return t.enableDevice=!1,t}(),c=function(n){function t(){var t=n.call(this,1)||this;t.add(new aidnlib.ScriptsLoaderCommand(["shared/main/js/lib.js"])),t.add(new o("shared/main/img/miku/tex.json",r.THREE));var e="shared/main/img/miku/box_miku.pmd";return 0<=navigator.userAgent.indexOf("Firefox")&&(e="shared/main/img/mikuu_ff/box_miku.pmd"),t.add(new three.ThreePmdLoadCommand(e)),t}return __extends(t,n),t}(s),d=function(n){function t(){var t=n.call(this)||this;return p.main=t,p.isMobile=aidn.util.checkMobile(),p.isMobile&&$(".nico").attr("href","http://sp.nicovideo.jp/mylist/4009728?sort=8"),aidn.util.checkJapanese()||$(".nico").hide(),$("#menu").stop().show(),$("#loading").hide(),p.device=new i,p.device.start(),t}return __extends(t,n),t.prototype.initialize=function(){var t=this;n.prototype.initialize.call(this),$("#menu").stop().show();var e=new c;e.addEventListener(a.COMPLETE,function(){return t._initComplete()}),e.execute()},t.prototype._initComplete=function(){this._three=new v,this._start(),$("#view").stop().delay(200).animate({opacity:.5},700,"linear")},t.prototype._start=function(){n.prototype._start.call(this)},t.prototype._update=function(){var t=this;n.prototype._update.call(this),window.requestAnimFrame(function(){return t._update()})},t.prototype._resize=function(){n.prototype._resize.call(this),$("#menu").stop().show()},t}(e),l=function(i){function t(){var t=this,e=.6;p.isMobile&&(e=.8);var n=new THREE.DotScreenPass(new THREE.Vector2(0,0),.5,e);return(t=i.call(this,n)||this)._epass=n,t}return __extends(t,i),Object.defineProperty(t.prototype,"uniforms",{get:function(){return this._epass.uniforms},enumerable:!0,configurable:!0}),t.prototype.start=function(t){void 0===t&&(t=120),i.prototype.start.call(this,t)},t}(function(){function t(t){this.__timeoutId=-1,t.enabled=!1,this._pass=t}return Object.defineProperty(t.prototype,"pass",{get:function(){return this._pass},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"enabled",{get:function(){return this._pass.enabled},set:function(t){this._pass.enabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderToScreen",{get:function(){return this._pass.renderToScreen},set:function(t){this._pass.renderToScreen=t},enumerable:!0,configurable:!0}),t.prototype.start=function(t){var e=this;void 0===t&&(t=120),this.enabled=!0,0<t&&(clearTimeout(this.__timeoutId),this.__timeoutId=setTimeout(function(){return e.__complete()},t))},t.prototype.__complete=function(){this.enabled=!1},t}()),f=function(){function t(t,e,n){this._effects=[],this._total=0;var i=new THREE.RenderPass(n,e),o=new THREE.EffectComposer(t);this._renderer=t,this._camera=e,this._scene=n,this._comp=o,this._pass=i,this._init()}return t.prototype._init=function(){this._efDotSc=new l,this._efDotSc.start(-1),this._effects=[this._efDotSc],this._total=this._effects.length},t.prototype.setSize=function(t,e){this._renderer.setSize(t,e),this._comp.setSize(t,e)},t.prototype.render=function(){for(var t=this._total,e=[this._pass],n=1,i=0;i<t;i++)this._effects[i].enabled&&(e[n]=this._effects[i].pass,n++);if(1<n){for(i=0;i<n;i++)e[i].renderToScreen=i==n-1;this._comp.passes=e,this._comp.render()}else this._renderer.render(this._scene,this._camera)},t}(),m=function(){function t(t){this._bone=t,this._defRot=t.rotation.clone(),this._defPos=t.position.clone()}return Object.defineProperty(t.prototype,"defRot",{get:function(){return this._defRot},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"defPos",{get:function(){return this._defPos},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return this._bone.position.x},set:function(t){this._bone.position.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this._bone.position.y},set:function(t){this._bone.position.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"z",{get:function(){return this._bone.position.z},set:function(t){this._bone.position.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotX",{get:function(){return this._bone.rotation.x},set:function(t){this._bone.rotation.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotY",{get:function(){return this._bone.rotation.y},set:function(t){this._bone.rotation.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rotZ",{get:function(){return this._bone.rotation.z},set:function(t){this._bone.rotation.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"scale",{get:function(){return this._bone.scale.x},set:function(t){this._bone.scale.set(t,t,t)},enumerable:!0,configurable:!0}),t.CENTER=0,t.UPPER_BODY=2,t.NECK=3,t.HEAD=4,t.L_SHOULDER=6,t.L_ARM=7,t.L_ELBOW=8,t.R_SHOULDER=11,t.R_ARM=12,t.R_ELBOW=13,t.LOWER_BODY=16,t.L_HAIR1=26,t.R_HAIR1=27,t.L_HAIR2=28,t.R_HAIR2=29,t.L_HAIR3=30,t.R_HAIR3=31,t}(),y=function(c){function t(t){var n=this,e=_.get("mesh");e.castShadow=!0,(n=c.call(this,e,t)||this)._mesh=e,n._bones=[];for(var i=e.skeleton.bones.length,o=0;o<i;o++)n._bones[o]=new m(e.skeleton.bones[o]);var r=e.material;for(o=0;o<r.length;o++){var s=r[o];s.shininess=0,s.userData.outlineParameters={};var a=new THREE.MeshBasicMaterial({map:s.map,skinning:!0});a.userData.outlineParameters=[],a.needsUpdate=!0,e.material[o]=a,s.needsUpdate=!0}var u=new THREE.MMDAnimationHelper({sync:!1});return u.enabled.physics=!1,n._helper=u,n._bones[m.L_ARM].rotZ=-h.toRad(30),n._bones[m.R_ARM].rotZ=h.toRad(30),n._bones[m.L_HAIR2].y-=1,n._bones[m.R_HAIR2].y-=1,n._mesh.rotation.y=-h.toDeg(60),p.device.addUpdate(n,function(t,e){return n._deviceUpdate(t,e)}),n}return __extends(t,c),Object.defineProperty(t.prototype,"mesh",{get:function(){return this._mesh},enumerable:!0,configurable:!0}),t.prototype._deviceUpdate=function(t,e){p.enableDevice=!0,p.isMobile&&(e-=.2,t*=1.4),this._poseUpdate(t,e)},t.prototype._poseUpdate=function(t,e){this._bones[m.UPPER_BODY].rotX=h.toRad(30*e-15),this._bones[m.UPPER_BODY].rotZ=-h.toRad(20*t),this._bones[m.NECK].rotZ=-h.toRad(20*t),this._bones[m.L_HAIR1].rotZ=-h.toRad(20*e-20),this._bones[m.R_HAIR1].rotZ=h.toRad(20*e-20),this._bones[m.L_HAIR2].rotZ=-h.toRad(30*e-30),this._bones[m.R_HAIR2].rotZ=h.toRad(30*e-30),this._bones[m.L_ARM].rotZ=-h.toRad(50*e-20),this._bones[m.R_ARM].rotZ=h.toRad(50*e-20),this._bones[m.L_ELBOW].rotZ=-h.toRad(10+30*e),this._bones[m.R_ELBOW].rotZ=h.toRad(10+30*e)},t.prototype.update=function(){if(this._mesh.rotation.y+=.85*n.delta,!p.enableDevice){var t=.8*Math.sin(1.23*n.time),e=.8*Math.cos(1.41*n.time);this._poseUpdate(t,e)}},t}(u),v=function(){function t(){var n=this,t=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.05,400);t.position.z=20,t.position.y=6;var e=new THREE.Scene;e.background=new THREE.Color(16777215);var i=Math.min(window.devicePixelRatio,2),o=document.getElementById("view"),r=this._renderer=new THREE.WebGLRenderer({antialias:!0});r.setPixelRatio(i),r.setSize(window.innerWidth,window.innerHeight),o.appendChild(r.domElement),this._renderer=r,this._scene=e,this._camera=t,this._model=new y(e),this._effeMng=new f(r,t,e),p.main.addUpdate(this,function(){return n._update()}),p.main.addResize(this,function(){return n._resize()});var s=new THREE.MeshBasicMaterial({color:13421772}),a=new three.PrimCube(this._scene,s,1,1,1);a.scale=7,a.y=0-a.scaleY/2,this._box=a,p.device.addUpdate(this,function(t,e){return n._deviceUpdate(t,e)})}return t.prototype._deviceUpdate=function(t,e){p.enableDevice=!0,this._updatePosition(t,e)},t.prototype._updatePosition=function(t,e){this._camera.position.y=5+1*e,this._camera.position.z=16+6*e,this._camera.position.x=0+1*t},t.prototype._update=function(){if(this._model.update(),this._box.rotationY=this._model.mesh.rotation.y,!p.enableDevice){var t=.8*Math.sin(1.33*n.time),e=.8*Math.cos(1.11*n.time);this._updatePosition(t,e)}this._effeMng.render()},t.prototype._resize=function(){var t=n.stw,e=n.sth;this._camera.fov=30+e/t*10,this._camera.aspect=t/e,this._camera.updateProjectionMatrix(),this._effeMng.setSize(t,e),this._effeMng.render()},t}()}(index||(index={})),index.check();